name: System Tests

permissions:
  id-token: write
  contents: read

on:
  workflow_dispatch:
  workflow_call:

jobs:
  discover-tests:
    runs-on: ubuntu-latest
    outputs:
      tests: ${{ steps.find_tests.outputs.tests }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Find Test Files
        id: find_tests
        run: |
          TEST_FILES=$(cd test/system-test && find . -name 'test_*.py' | sed -e 's|^\./||' -e 's|^test_||' -e 's|\.py$||')
          JSON_ARRAY=$(printf '%s\n' "${TEST_FILES[@]}" | jq -R . | jq -s .)
          echo "tests=$JSON_ARRAY" | sed ':a;N;$!ba;s/\n//g' >> $GITHUB_OUTPUT

  test:
    name: ${{ '' }}
    needs: discover-tests
    secrets: inherit # pragma: allowlist secret
    strategy:
      fail-fast: false
      matrix:
        test: ${{ fromJson(needs.discover-tests.outputs.tests) }}
    uses: ./.github/workflows/system-test.yml
    with:
      test: ${{ matrix.test }}

  jwt-issuer-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log into Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.MANAGED_ID_CLIENT_ID }}
          tenant-id: ${{ secrets.MANAGED_ID_TENANT_ID }}
          subscription-id: 7ca35580-fc67-469c-91a7-68b38569ca6e

      - name: Install Dependencies
        env:
          GH_TOKEN: ${{ github.token }}
        run: ./scripts/tools/install-deps.sh

      - name: Run System Tests
        env:
          TEST_ENVIRONMENT: ccf/az-cleanroom-aci
        run: |
          ./scripts/jwt_issuer_up.sh
